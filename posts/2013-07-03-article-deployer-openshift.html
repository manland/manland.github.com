<!DOCTYPE html><html lang="fr-fr"><head><meta charset="utf-8"><title>Romain Maneschi - Scala/playframework sur openshift</title><meta name="author" content="Romain Maneschi"><meta name="viewport" content="width=device-width"><link href="http://fonts.googleapis.com/css?family=Open+Sans" rel="stylesheet" type="text/css"><link rel="stylesheet" type="text/css" href="/assets/css/default-20150317.css"><link rel="stylesheet" type="text/css" href="/assets/css/monokai_sublime-20150317.css"><link rel="alternate" type="application/rss+xml" title="RSS" href="/feed.xml"><link rel="shortcut icon" type="image/ico" href="/assets/images/favicon.ico"><script type="text/javascript">var _gaq = _gaq || [];
      _gaq.push(['_setAccount', 'UA-36759922-1']);
      _gaq.push(['_trackPageview']);

      (function() {
        var ga = document.createElement('script'); ga.type = 'text/javascript'; ga.async = true;
        ga.src = ('https:' == document.location.protocol ? 'https://ssl' : 'http://www') + '.google-analytics.com/ga.js';
        var s = document.getElementsByTagName('script')[0]; s.parentNode.insertBefore(ga, s);
      })();</script></head><body><header><a class="title" href="/index.html"><img class="presentation-img" src="/assets/images/romain.png"><div class="presentation-name"><span>Romain Maneschi</span> <span class="presentation-baseline">Artisan développeur</span></div></a><nav><a href="/index.html" class="btn">Accueil</a> <a href="/cv.html" class="btn btn-cv"> CV</a> <a href="/projets.html" class="btn btn-projet"> Projets</a> <a href="/articles.html" class="btn btn-article"> Ecrits</a> <a href="/contact.html" class="btn social-network-tab">Contact</a></nav><div class="social-network"><a href="/assets/images/CV_Romain_Maneschi.pdf" target="_blank"><img src="/assets/images/cvpdf.gif" width="30px"></a> <a href="https://twitter.com/RmManeschi" target="_blank"><img src="/assets/images/brand/twitter.png" width="30px"></a> <a href="https://github.com/manland" target="_blank"><img src="/assets/images/brand/github.png" width="30px"></a> <a href="http://www.viadeo.com/fr/profile/romain.maneschi" target="_blank"><img src="/assets/images/brand/viadeo.png" width="30px"></a> <a href="http://www.linkedin.com/pub/romain-maneschi/5b/422/aa9" target="_blank"><img src="/assets/images/brand/linkedin.png" width="30px"></a> <a href="https://plus.google.com/+RomainManeschi" target="_blank"><img src="/assets/images/brand/googleplus.png" width="30px"></a> <a href="/feed.xml" target="_blank"><img src="/assets/images/brand/rss.png" width="30px"></a></div></header><div class="container-max"><div class="article-max"><span class="publish-date">Jul 2013</span><h2 class="article-title">Scala/playframework sur openshift</h2><div class="container-img"><img id="image" src="/assets/images/article/deployersuropenshift/openshift_logo.png" alt="Scala/playframework sur openshift screenshot" onclick="GALLERY.showBig()"></div><div id="urls" style="display:none">article/deployersuropenshift/openshift_logo.png</div><script type="text/javascript" src="/assets/js/gallery-20150317.js"></script><p>Vous connaissiez <a href="http://aws.amazon.com/" target="_blank">AWS</a>, <a href="https://www.heroku.com/" target="_blank">Heroku</a> ou <a href="https://www.dotcloud.com/" target="_blank">dotCloud</a>. Voici arriver un nouvel acteur d&#39;importance sur ce marché tant convoité du Paas. Et ce nouvel acteur n&#39;est ni plus ni moins que <a href="https://www.redhat.com/" target="_blank">RedHat</a>.</p><h3 id="commercial-mode-">Commercial mode !</h3><p>Ce que nous propose RedHat par le biai de son outil <a href="https://www.openshift.com" target="_blank">OpenShift</a> est tout simplement magique. Non seulement il est à la hauteur de ses concurrents existants, mais en plus il est open-source. Vous l&#39;aurez compris son leitmotiv, est : &quot;venez tester votre solution chez nous, puis si elle marche, payez pour scaler, ou achetez un serveur et installez OpenStack&quot;. Sympa de ne plus être tributaire d&#39;un service, non ? OpenStack étant la pile logicielle sur laquelle est basée OpenShift.</p><p>Son système repose sur des gears, on peut les assimiler à une instance virtuelle d&#39;un serveur. Là où heroku ne propose gratuitement qu&#39;un web-dyno, OpenShift nous en propose 3. Soit en théorie, 1,5 Go de RAM. Comment font-ils ? Tout simplement en vous attribuant en réalité 1 seul gear, et lorsque votre application est à 100% de cpu ou de ram, il scale automatiquement à 2 puis 3. Lorsque votre application redescend, il enlève graduellement les gears. Ce qui permet de mieux répartir les ressources matérielles. Bien sûr c&#39;est basé sur le fait que tout le monde, n&#39;utilise pas tout le temps toute la ressource...</p><p>Son écosystème des services tiers n&#39;est pas encore à la hauteur d&#39;Heroku, mais l&#39;open-source va faire accélérer de manière exponentielle ce nombre. Il contient cependant tout ce dont on a besoin de base. Une jvm prêt à l&#39;emploi, du MongoDb ou encore mysql. Je vous laisse faire le tour de leurs <a href="https://www.openshift.com/developers/technologies" target="_blank">Cartridges</a> pour en savoir plus.</p><p>Ce que j&#39;ai particulièrement aimé chez eux, c&#39;est qu&#39;ils vous donne l&#39;accès ssh à la vm. Certes un cli existe pour vous faciliter déploiement et maintenance, mais qu&#39;est-ce que c&#39;est sympa de pouvoir faire un &quot;top&quot; pour comprendre ce qui se passe sur le serveur :D</p><p>Après cette rapide intro passons aux choses sérieuses : le déploiement sur OpenShift !</p><h3 id="sur-openshift">Sur OpenShift</h3><p>Après avoir créé un compte chez eux, vous pouvez uploader votre clé ssh publique à partir de leur site. Ensuite il suffit de créer une application pour récupérer l&#39;adresse url de connexion par ssh. Malheureusement, il n&#39;existe pas (encore) de config pour scala/playframework. Qu&#39;à cela ne tienne, nous allons utiliser un serveur &quot;nu&quot; et tout faire nous même. C&#39;est là que l&#39;open-source et le fait d&#39;avoir le contrôle sur le serveur, prennent tout leur sens.</p><p><img src="/assets/images/article/deployersuropenshift/pubKey.png"> <img src="/assets/images/article/deployersuropenshift/app.png"> <img src="/assets/images/article/deployersuropenshift/createAppDIY.png"></p><p>OpenShift, tout comme heroku, va créer un repo git pour votre synchro. Il vous faut donc soit le merger dans votre projet actuel, soit démarrer votre projet dans ce répertoire.</p><p>Dans ce dossier, se trouve un répertoire .openshift dans lequel vous retrouvez deux nouveaux répertoires : .action_hooks et .cron. Le premier permet d&#39;automatiser des tâches lors du déploiement, le second de créer des crons.</p><p><img src="/assets/images/article/deployersuropenshift/openShiftRep.png" style="width:150px"></p><h3 id="au-boulot">Au boulot</h3><p>Après plusieurs nuits de tests, j&#39;ai abandonné l&#39;idée de vouloir pousser les sources sur le serveur afin qu&#39;il compile et fasse tout tout seul (comme Heroku). A la place je compile sur mon pc et je pousse la version staggée de mon projet sur leur serveur.</p><p>Pour cela rien de plus simple, un petit <a href="https://raw.github.com/Froggies/Skimbo/master/script/deploy_openshift.sh" target="_blank">script shell</a>, largement inspiré par <a href="http://greweb.me/2013/05/playframework-simple-deployment-scripts/" target="_blank">celui-ci</a>.</p><p>En deux mots, il compile la version actuelle du projet grâce à la fonction stage de playframework. Il arrête le serveur playframework et il rsync (upload le différentiel) le résultat du pc, vers le serveur distant. Enfin, il relance le serveur playframework distant.</p><p>Comme vous pourrez le remarquer, j&#39;utilise les fichiers scripts <a href="https://github.com/Froggies/Skimbo/blob/master/.openshift/action_hooks/start" target="_blank">start</a> et <a href="https://github.com/Froggies/Skimbo/blob/master/.openshift/action_hooks/stop" target="_blank">stop</a> du répertoire .openshift/action_hooks. C&#39;est pour garder le fonctionnement standard d&#39;Openshift, si un jour un cartbridge playframeworks sort, ou si le serveur est mis à jour ce seront ces scripts qui seront appelés.</p><p>La procédure dure une dizaine de minutes pour une interruption de service n&#39;excédant pas les 5 minutes. Certes interruption de service il y a, mais elle est raisonnable. Je pense également qu&#39;on peut imaginer de déplacer l&#39;arrêt du serveur après le rsync mais cela dépend de votre projet et de votre déploiement.</p></div></div></body></html>